<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:cc="http://java.sun.com/jsf/composite"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html">

    <!-- INTERFACE -->
    <cc:interface>
        <cc:attribute name="entity" required="true" type="java.lang.Object" />
        <cc:attribute name="entityClass" type="java.lang.Class" />
        <cc:attribute name="collapsed" type="java.lang.Boolean" default="true" />
        <cc:attribute name="buttonStyleClass" type="java.lang.String"  />
        <cc:attribute name="panelStyleClass" type="java.lang.String" />
        <cc:attribute name="buttonIcon" type="java.lang.String" default="#{icons.audit}" />
        <cc:attribute name="fixedExpanded" type="java.lang.Boolean" default="false" />
    </cc:interface>

    <!-- IMPLEMENTATION -->
    <cc:implementation>
        <h:outputStylesheet library="xpert" name="css/style.css" />
        <span id="#{cc.attrs.clientId}">

            <h:inputHidden id="x-valueCollapsed" value="#{cc.attrs.collapsed}"/>

            <h:panelGroup id="x-auditingPanelId" layout="block" rendered="#{auditBean.isPersisted(cc.attrs.entity)}">

                <p:commandButton id="x-button-auditing"
                                 process="@this" 
                                 update="x-panel-detail-auditing-id"
                                 action="#{auditBean.detail}" 
                                 icon="#{cc.attrs.buttonIcon}"
                                 styleClass="x-button-detail-auditing #{cc.attrs.buttonStyleClass}"
                                 value="#{xmsg['auditing']}"
                                 oncomplete="closeAllRowExpansion(); clickButton();">
                    <f:setPropertyActionListener value="#{cc.attrs.entity}" target="#{auditBean.object}" />
                </p:commandButton>

                <p:remoteCommand name="closeAllRowExpansion" oncomplete="PF('x-widgetDataTableAudit').collapseAllRows()" />

                <h:panelGroup rendered="#{not cc.attrs.collapsed}">
                    <f:event type="preRenderComponent" listener="#{auditBean.detail(cc.attrs.entity)}" />
                </h:panelGroup>

                <h:panelGroup id="x-panel-detail-auditing-id" styleClass="x-panel-detail-auditing #{cc.attrs.panelStyleClass}" layout="block">

                    <ui:param name="xpertAuditingDetail" value="#{auditBean.getDetailAuditBean(cc.attrs.entity)}"/>

                    <p:panel id="x-panelAuditToggle" header="Teste" widgetVar="x-widgetAuditToggle" toggleable="true" style="width: 100%" rendered="#{auditBean.enableAudit}">
                        <f:facet name="header">
                            <p:commandLink process="@this" update="@none" onclick="PF('x-widgetAuditToggle').toggle(); closeTab();" rendered="#{!cc.attrs.fixedExpanded}">
                                <h:outputText styleClass="ui-icon pi pi-chevron-down"/>
                            </p:commandLink>
                            #{xmsg['auditingDetail']}
                        </f:facet>
                        <ui:include src="./auditDetail.xhtml"/>
                    </p:panel>

                </h:panelGroup>

                <script>
                    /*<![CDATA[*/

                    $(document).ready(function () {
                        var collapsed = $("[id='#{cc.clientId}:x-valueCollapsed']");
                        if (collapsed.val() === 'true') {
                            closeTab();
                        } else {
                            clickButton();
                        }
                    });

                    function clickButton() {
                        $(PrimeFaces.escapeClientId('#{cc.attrs.clientId}')).find('.x-button-detail-auditing').hide();
                        $(PrimeFaces.escapeClientId('#{cc.attrs.clientId}')).find('.x-panel-detail-auditing').show();
                    }

                    function closeTab() {
                        $(PrimeFaces.escapeClientId('#{cc.attrs.clientId}')).find('.x-button-detail-auditing').show();
                        $(PrimeFaces.escapeClientId('#{cc.attrs.clientId}')).find('.x-panel-detail-auditing').hide();
                    }

                    /*]]>*/
                </script>

            </h:panelGroup>

        </span>
    </cc:implementation>
</html>